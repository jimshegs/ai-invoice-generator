<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Invoice History</title>
  <!-- reuse global stylesheet -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

{% block content %}
<div class="page-bg">          
  <div class="card history-card">
    <!-- <h1 class="title">Past Invoices</h1> -->
    <div class="history-toolbar">
        <h1 class="title">Past Invoices</h1>
        <form class="history-search" method="get" action="{{ url_for('history') }}">
            <input type="text" name="q" class="search-input"
                placeholder="Search by invoice # or client…" value="{{ q }}">
            <button class="search-button" id="search-button" type="submit">Search</button>
        </form>
    </div>


    {% if invoices %}
      <table class="table history-table">
        <thead>
          <tr>
            <th style="width:120px">Invoice #</th>
            <th style="width:140px">Date</th>
            <th style="width:140px">Client</th>
            <th style="width:140px">Total</th>
            <th style="width:100px">PDF</th>
          </tr>
        </thead>
        <tbody id="historyTbody">
          {% for inv in invoices %}
          <tr data-invoice="{{ inv.invoice_no }}">
            <td>{{ inv.invoice_no }}</td>
            <td>{{ inv.date }}</td>
            <td>{{ inv.client }}</td>
            <td>{{ '%.2f'|format(inv.total) }}</td>
            <td class="actions-cell">
                {% if inv.pdf_path %}
                    <a class="btn-download" title="Download PDF"
                    href="{{ url_for('static', filename=inv.pdf_path) }}" target="_blank">⬇︎</a>
                {% endif %}
                <button class="btn-danger delete-btn" type="button" data-id="{{ inv.invoice_no }}">Delete</button>
            </td>

          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="history-pagination">
        {% if has_prev %}
        <a class="btn-secondary" href="{{ url_for('history', page=page-1, q=q) }}">← Prev</a>
        {% else %}
        <span class="btn-secondary disabled">← Prev</span>
        {% endif %}

        <span class="page-indicator">Page {{ page }} of {{ total_pages }}</span>

        {% if has_next %}
        <a class="btn-secondary" href="{{ url_for('history', page=page+1, q=q) }}">Next →</a>
        {% else %}
        <span class="btn-secondary disabled">Next →</span>
        {% endif %}
    </div>
    {% else %}
      <p>No invoices yet.</p>
    {% endif %}

    <div class="actions">
      <a href="{{ url_for('index') }}" class="btn-secondary">← Back to new invoice</a>
    </div>
  </div>
</div>
{% endblock %}

</body>
</html>

<script>
document.addEventListener('click', async (e) => {
  if (!e.target.classList.contains('delete-btn')) return;

  const id = e.target.dataset.id;
  if (!confirm(`Delete invoice ${id}? This cannot be undone.`)) return;

  try {
    const res = await fetch(`/history/delete/${encodeURIComponent(id)}`, {
      method: 'POST',
      headers: { 'Accept': 'application/json' }
    });
    const body = await res.json();
    if (!res.ok || !body.ok) throw new Error(body.error || 'Delete failed');

    // Remove the row from the table
    const row = document.querySelector(`tr[data-invoice="${CSS.escape(id)}"]`);
    if (row) row.remove();

    // If table is empty, refresh to show the "No invoices yet" message/pager state
    if (!document.querySelector('#historyTbody tr')) {
      window.location.reload();
    }
  } catch (err) {
    alert(err.message);
  }
});
</script>
